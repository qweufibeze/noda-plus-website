name: Deploy to Server

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            # Install Caddy if not installed
            if ! command -v caddy &> /dev/null; then
              apt update
              apt install -y debian-keyring debian-archive-keyring apt-transport-https curl
              curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
              curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | tee /etc/apt/sources.list.d/caddy-stable.list
              apt update
              apt install -y caddy
            fi

            # Create site directory
            mkdir -p /var/www/noda.plus

            # Configure Caddy
            cat > /etc/caddy/Caddyfile << 'EOF'
            noda.plus {
                root * /var/www/noda.plus
                file_server
                encode gzip

                # SPA fallback
                try_files {path} /index.html

                # Cache static assets
                @static {
                    path *.css *.js *.png *.jpg *.jpeg *.gif *.svg *.ico *.woff *.woff2
                }
                header @static Cache-Control "public, max-age=31536000"
            }

            www.noda.plus {
                redir https://noda.plus{uri} permanent
            }
            EOF

            # Reload Caddy
            systemctl enable caddy
            systemctl reload caddy || systemctl start caddy

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          source: "public/*"
          target: "/var/www/noda.plus"
          strip_components: 1

      - name: Set permissions
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            chown -R caddy:caddy /var/www/noda.plus
            chmod -R 755 /var/www/noda.plus
